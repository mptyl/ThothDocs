# Installazione di ThothAI in locale

L'installazione in locale comprende l'installazione del backend Django, del SQL Generator (FastAPI) e del frontend Next.js.

!!! info "Sviluppo Locale"
    Lo sviluppo locale utilizza `.env.local` nella directory root e lo script `start-all.sh` per avviare tutti i servizi


!!! note "Il setup Django"

    Come si imposta un'applicazione Django è al di fuori dello scope di questa documentazione
    Andare alla [pagina ufficiale di Django](https://docs.djangoproject.com/en/5.2/howto/deployment/) su questo argomento per ulteriori dettagli.
    In questo progetto si assume che un utente interessato a gestire il backend in modalità Developer conosca Django abbastanza da esssere in grado di modificare Thoth senza difficoltà

## 1 - Sistema di Configurazione per Sviluppo Locale

### 1.1 - File di Configurazione

#### .env.local
- **Ruolo**: Configurazione unificata per tutti i servizi locali
- **Creazione**: Copiare da `.env.template` e personalizzare
- **Contenuto**: API keys, porte locali, URL servizi, credenziali
- **Utilizzo**: Caricato automaticamente da `start-all.sh` che rimuove un'eventuale variabile `PORT` generica per evitare conflitti

### 1.2 - Flusso di Configurazione Locale

```
.env.local → start-all.sh → export variabili → Servizi ereditano
           ↓                      ↓
    (filtro PORT=)        Django, SQL Gen, Frontend
```

**Processo:**
1. `start-all.sh` carica `.env.local` (escluso PORT generico)
2. Esporta variabili nell'ambiente shell
3. Ogni servizio eredita le variabili:
   - Django (porta 8200)
   - SQL Generator (porta 8180) 
   - Frontend (porta 3200)
   - Mermaid Service (porta 8003)
   - Qdrant (porta 6334)

## 2 - Preparazione Ambiente

### 2.1 - Impostazione del file .env.local

1. Copiare il template:
```bash
cp .env.local.template .env.local
```

2. Modificare `.env.local` con le proprie configurazioni:
   - API keys degli LLM (almeno uno richiesto)
   - Embedding service configuration
   - Porte locali (se quelle di default sono occupate)
   - Credenziali admin
   - Opzionale: `MERMAID_SERVICE_URL` (se non impostato, `start-all.sh` usa `http://localhost:${MERMAID_SERVICE_PORT}`)


### 2.2 - Gestione Python con uv

Il progetto usa `uv` per gestire Python in modo consistente:

```bash
# Installare uv se non presente
curl -LsSf https://astral.sh/uv/install.sh | sh

# Installare Python gestito da uv (3.13.5)
uv python install 3.13.5

# Creare .python-version files
echo "3.13.5" > backend/.python-version
echo "3.13.5" > frontend/sql_generator/.python-version
```

### 2.3 - Installazione Dipendenze

#### Backend Django
```bash
cd backend
uv sync  # Crea .venv e installa dipendenze
cd ..
```

#### SQL Generator
```bash
cd frontend/sql_generator
uv sync  # Crea .venv e installa dipendenze
cd ../..
```

#### Frontend Next.js
```bash
cd frontend
npm install
cd ..
```

## 3 - Avvio Servizi con start-all.sh

### 3.1 - Utilizzo Base

```bash
# Dare permessi di esecuzione (solo prima volta)
chmod +x start-all.sh

# Avviare tutti i servizi
./start-all.sh
```

### 3.2 - Servizi Avviati

Lo script avvia automaticamente:
- **Django Backend**: http://localhost:8200
- **SQL Generator**: http://localhost:8180
- **Frontend**: http://localhost:3200
- **Mermaid Service**: http://localhost:8003
- **Qdrant** (Docker): http://localhost:6334 (volume `qdrant_storage/` nella root del progetto)

### 3.3 - Gestione Servizi

- **Stop tutti**: `Ctrl+C` nello script
- **Logs Django**: Visibili nel terminale
- **Logs SQL Gen**: Visibili nel terminale
- **Frontend Dev**: Hot reload automatico
- **Qdrant**: alla chiusura lo script chiede se arrestare il container (altrimenti resta attivo)

## 4 - Configurazione Database e Migrazioni

### 4.1 - Migrazioni Django
`start-all.sh` non esegue automaticamente le migrazioni. Eseguirle manualmente quando necessario:

```bash
cd backend
export $(grep -v '^#' ../.env.local | grep -v '^PORT=' | xargs)
uv run python manage.py migrate
```

### 4.2 - Creazione Superuser
Per accedere al pannello di amministrazione Django:

```bash
cd backend
export $(grep -v '^#' ../.env.local | grep -v '^PORT=' | xargs)
uv run python manage.py createsuperuser
```

### 4.3 - Verifica accesso e servizi

- **Backend Home**: `http://localhost:8200`
- **Django Admin**: `http://localhost:8200/admin` (richiede superuser)
- **API SQL Generator**: `http://localhost:8180/docs`
- **Frontend**: `http://localhost:3200`

## 5 - Risoluzione Problemi

### 5.1 - Conflitti di Porta
Se le porte di default sono occupate, modificare in `.env.local`:
- `BACKEND_LOCAL_PORT=8200`
- `SQL_GENERATOR_LOCAL_PORT=8180`
- `FRONTEND_LOCAL_PORT=3200`
- `MERMAID_SERVICE_LOCAL_PORT=8003`

### 5.2 - Python Version
Se `uv` usa il Python di sistema invece di quello gestito:
1. Verificare `.python-version` files nelle directory
{{ ... }}
3. Ricreare venv: `rm -rf .venv && uv sync`

### 5.3 - Variabili Ambiente
- **PORT generico**: Filtrato da `start-all.sh` per evitare conflitti
- **API Keys**: Devono essere configurate in `.env.local`
- **Database**: SQLite di default, PostgreSQL/MySQL richiedono configurazione
- **BACKEND AI**: `start-all.sh` valida provider/modello via `scripts/validate_backend_ai.py` (necessita Python)

### 5.4 - Requisiti strumenti
- **SQL Generator**: richiede `uv` installato
- **Mermaid Service**: richiede Node.js v18+
- **Frontend**: richiede Node.js v20+
- **Qdrant**: richiede Docker attivo; espone `localhost:6334`

## 6 - Differenze Docker vs Locale

| Aspetto | Docker | Locale |
|---------|--------|--------|
| Config File | `config.yml.local` → `.env.docker` | `.env.local` |
| Script Avvio | `install.sh` | `start-all.sh` |
| Porte Backend | 8040 | 8200 |
| Porte SQL Gen | 8020 | 8180 |
| Porte Frontend | 3040 | 3200 |
| Mermaid Service | (container dedicato) | 8003 |
| Qdrant | container su rete Docker | 6334 (host) |
| Python | Container isolato | uv-managed 3.13.5 |
| Database | Volume Docker | File locale |

## 7 - Arresto dei servizi

- Premere `Ctrl+C` nella shell di `start-all.sh`
- Alla richiesta, scegliere se fermare anche il container `qdrant-thoth`

