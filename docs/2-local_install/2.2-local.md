# Installazione di ThothAI in locale

L'installazione in locale comprende l'installazione del backend Django, del SQL Generator (FastAPI) e del frontend Next.js.

!!! info "Sviluppo Locale"

    L'esecuzione locale utilizza `config.yml.local` come configurazione primaria, che viene automaticamente convertito in `.env.local` dallo script `start-all.sh` all'avvio dei servizi


!!! note "Il setup Django"

    Come si imposta un'applicazione Django è al di fuori dello scope di questa documentazione
    Andare alla [pagina ufficiale di Django](https://docs.djangoproject.com/en/5.2/howto/deployment/) su questo argomento per ulteriori dettagli.
    In questo progetto si assume che un utente interessato a gestire il backend in modalità Developer conosca Django abbastanza da esssere in grado di modificare Thoth senza difficoltà

## 1 - Sistema di Configurazione per Sviluppo Locale

### 1.1 - File di Configurazione

#### config.yml.local (File Principale)
- **Ruolo**: Configurazione unificata YAML per tutti i servizi (Docker e locale)
- **Creazione**: Copiare da `config.yml` e personalizzare
- **Contenuto**: API keys, porte locali, URL servizi, credenziali, database flags
- **Utilizzo**: Fonte primaria da cui viene auto-generato `.env.local`

#### .env.local (Generato Automaticamente)
- **Ruolo**: File env generato da `start-all.sh` per i servizi locali
- **Generazione**: Automatica tramite `scripts/generate_env_local.py`
- **Contenuto**: Variabili d'ambiente estratte da `config.yml.local`
- **Note**: Non modificare manualmente - editare `config.yml.local` invece

### 1.2 - Flusso di Configurazione Locale

```
config.yml.local → start-all.sh → generate_env_local.py → .env.local
                        ↓                                      ↓
               validate_backend_ai.py                 export variabili
                        ↓                                      ↓
            update_local_db_dependencies.py          Servizi ereditano
                        ↓
                  uv sync (auto)
```

**Processo:**

1. `start-all.sh` verifica/genera `.env.local` da `config.yml.local`
2. Forza `DEBUG=TRUE` per lo sviluppo locale
3. Risolve dipendenze database e sincronizza automaticamente con `uv` se necessario
4. Valida provider AI e modello
5. Esporta variabili nell'ambiente shell (escluso PORT generico)
6. Avvia i servizi (vedi 3.3 per elenco e URL)

## 2 - Preparazione Ambiente

### 2.1 - Impostazione del file config.yml.local

1. Copiare il template:
```bash
cp config.yml config.yml.local
```

2. Modificare `config.yml.local` con le proprie configurazioni:
   - **API keys** degli LLM (almeno uno richiesto: OpenAI, Gemini, o Anthropic)
   - **Embedding service** configuration
   - **Porte locali** (se quelle di default sono occupate)
   - **Database flags** (quali database abilitare: sqlite, postgresql, mysql, informix)
   - **Credenziali admin** (per il superuser Django)
   - Opzionale: **MERMAID_SERVICE_URL** (default: `http://localhost:8003`)

!!! warning "Non modificare .env.local direttamente"
    Il file `.env.local` viene auto-generato da `start-all.sh`. Tutte le modifiche devono essere fatte in `config.yml.local`.


### 2.2 - Installazione uv (Richiesto)

Il progetto usa `uv` per gestire Python e le dipendenze:

```bash
# Installare uv
curl -LsSf https://astral.sh/uv/install.sh | sh

# Installare Python 3.13.5 (opzionale, uv lo farà automaticamente)
uv python install 3.13.5
```

!!! success "Dipendenze Auto-Gestite"
    `start-all.sh` sincronizza **automaticamente** tutte le dipendenze Python e Node.js quando necessario:
    
    - **Backend Django**: `uv lock --refresh && uv sync` (se cambiano i database abilitati)
    - **SQL Generator**: `uv sync --frozen`
    - **Frontend**: `npm install` (se manca node_modules)
    - **Mermaid Service**: `npm install` (se manca node_modules)

### 2.3 - Installazione Manuale Dipendenze (Opzionale)

Se si preferisce installare manualmente prima di avviare `start-all.sh`:

#### Backend Django
```bash
cd backend
uv sync
cd ..
```

#### SQL Generator
```bash
cd frontend/sql_generator
uv sync
cd ../..
```

#### Frontend Next.js
```bash
cd frontend
npm install
cd ..
```

#### Mermaid Service
```bash
cd docker/mermaid-service
npm install
cd ../..
```

!!! note "Non Necessario"
    Questi passaggi sono **opzionali** - `start-all.sh` li esegue automaticamente se necessario.

## 3 - Avvio Servizi con start-all.sh

### 3.1 - Cosa fa start-all.sh

Lo script esegue automaticamente tutti i passaggi necessari:

1. ✅ Verifica esistenza di `config.yml.local`
2. ✅ Genera/aggiorna `.env.local` da `config.yml.local` (vedi 1.1)
3. ✅ Forza `DEBUG=TRUE` per sviluppo locale
4. ✅ Risolve dipendenze database e sincronizza con `uv` (vedi 2.3)
5. ✅ Valida provider AI e modello (vedi 5.3)
6. ✅ Carica variabili d'ambiente
7. ✅ Avvia tutti i servizi (vedi 3.3 per elenco)
8. ✅ Verifica che ogni servizio sia avviato correttamente

### 3.2 - Utilizzo Base

```bash
# Dare permessi di esecuzione (solo prima volta)
chmod +x start-all.sh

# Avviare tutti i servizi
./start-all.sh
```

!!! tip "Prima Esecuzione"
    Alla prima esecuzione lo script esegue l'auto-sync delle dipendenze (vedi 2.3) e crea/avvia il container Qdrant. Questo può richiedere alcuni minuti.

### 3.3 - Servizi Avviati

Lo script avvia automaticamente:

- **Django Backend**: http://localhost:8200
- **SQL Generator**: http://localhost:8180
- **Frontend**: http://localhost:3200
- **Mermaid Service**: http://localhost:8003
- **Qdrant** (Docker): http://localhost:6334 (volume `qdrant_storage/` nella root del progetto)

### 3.4 - Gestione Servizi

Per arresto e cleanup, vedi sezione 8 - Arresto dei servizi.

## 4 - Configurazione Database e Migrazioni

!!! warning "Migrazioni Non Automatiche"
    `start-all.sh` **non** esegue automaticamente le migrazioni Django. Devono essere eseguite manualmente.

### 4.1 - Migrazioni Django

Eseguire le migrazioni la prima volta o dopo modifiche al modello:

```bash
cd backend
export $(grep -v '^#' ../.env.local | grep -v '^PORT=' | xargs)
uv run python manage.py migrate
```

### 4.2 - Creazione Superuser

Per accedere al pannello di amministrazione Django:

```bash
cd backend
export $(grep -v '^#' ../.env.local | grep -v '^PORT=' | xargs)
uv run python manage.py createsuperuser
```

!!! tip "Credenziali Admin da config.yml.local"
    Le credenziali admin possono essere pre-configurate in `config.yml.local` (sezione `admin`).

 

## 5 - Risoluzione Problemi

### 5.1 - Conflitti di Porta
Se le porte di default sono occupate, modificare in `config.yml.local`:
```yaml
local:
  ports:
    backend: 8200
    sql_generator: 8180
    frontend: 3200
    mermaid_service: 8003
```

Poi riavviare `start-all.sh` che rigenererà `.env.local` automaticamente.

### 5.2 - Python Version
Se `uv` usa il Python di sistema invece di quello gestito:
1. Verificare `.python-version` files nelle directory (backend e frontend/sql_generator)
2. Installare esplicitamente: `uv python install 3.13.5`
3. Ricreare venv: `rm -rf .venv && uv sync`

### 5.3 - Variabili Ambiente
- **Configurazione primaria**: Tutte le variabili devono essere configurate in `config.yml.local`
- **PORT generico**: Filtrato da `start-all.sh` per evitare conflitti
- **API Keys**: Configurate in `config.yml.local` (sezione `llm`)
- **Database**: Abilitare/disabilitare in `config.yml.local` (sezione `databases`)
- **BACKEND AI**: `start-all.sh` valida automaticamente provider/modello via `scripts/validate_backend_ai.py`
- **Rigenerazione automatica**: Se `config.yml.local` è più recente di `.env.local`, viene rigenerato

### 5.4 - Requisiti strumenti
- **SQL Generator**: richiede `uv` installato
- **Mermaid Service**: richiede Node.js v18+
- **Frontend**: richiede Node.js v20+
- **Qdrant**: richiede Docker attivo; espone `localhost:6334`

## 6 - Differenze Docker vs Locale

| Aspetto | Docker | Locale |
|---------|--------|--------|
| Config File | `config.yml.local` → `.env.docker` (auto) | `config.yml.local` → `.env.local` (auto) |
| Script Avvio | `install.sh` | `start-all.sh` |
| Porte Backend | 8040 | 8200 |
| Porte SQL Gen | 8020 | 8180 |
| Porte Frontend | 3040 | 3200 |
| Mermaid Service | container dedicato | processo Node.js (porta 8003) |
| Qdrant | container su rete Docker | container esposto su localhost:6334 |
| Python | Container isolato | uv-managed 3.13.5 (.venv locale) |
| Database | Volume Docker | File locale (sqlite) o connessioni native |
| Dipendenze | Build-time nel container | Auto-sync da start-all.sh |
| DEBUG | Configurabile | Sempre TRUE (forzato) |

## 7 - Workflow Completo di Setup

### 7.1 - Prima Installazione

```bash
# 1. Clonare il repository
git clone https://github.com/mptyl/ThothAI.git
cd ThothAI

# 2. Installare uv
curl -LsSf https://astral.sh/uv/install.sh | sh

# 3. Configurare
cp config.yml config.yml.local
# Editare config.yml.local con le proprie API keys e configurazioni

# 4. Avviare tutto (auto-install dipendenze)
chmod +x start-all.sh
./start-all.sh

# 5. Poi esegui migrazioni e crea il superuser come descritto in 4.1 e 4.2
```

### 7.2 - Sviluppo Quotidiano

Per avviare i servizi in sviluppo, vedi 3.2 - Utilizzo Base.

### 7.3 - Aggiornamento Configurazione

```bash
# 1. Modificare config.yml.local
vim config.yml.local  # o altro editor

# 2. Riavviare start-all.sh
# Lo script rileva il cambiamento e rigenera .env.local automaticamente
./start-all.sh
```

## 8 - Arresto dei servizi

- Premere `Ctrl+C` nella shell di `start-all.sh`
- Alla richiesta, scegliere se fermare anche il container `qdrant-thoth`
- Lo script arresta ordinatamente tutti i servizi avviati

