# 3.4.2 Gestione dei Log

## Panoramica del Sistema di Logging

ThothSL implementa un sistema di logging duale che garantisce la massima visibilità e tracciabilità delle operazioni dell'applicazione. Il sistema è progettato per soddisfare sia le esigenze di monitoraggio in tempo reale che l'analisi post-mortem dei problemi.

## Architettura del Logging

### Logging Duale: Logfire e Filesystem

L'applicazione ThothSL implementa un sistema di logging **duale** che registra simultaneamente:

1. **Logfire**: Piattaforma di monitoraggio cloud per tracciamento in tempo reale, metriche di performance e analisi avanzata
2. **Filesystem locale**: Log su file per accesso diretto, persistenza locale e analisi offline

Questo approccio garantisce che i log siano sempre disponibili sia attraverso l'interfaccia web di Logfire che direttamente sui file di sistema.

## Struttura dei Log su Filesystem

### Directory dei Log

I log su filesystem sono raccolti nella directory:
```
/ThothSL/logs/
```

La struttura include:
- **Directory principale**: `/logs/` nella root del progetto
- **Sottodirectory di archivio**: `/logs/archives/` per la conservazione dei log storici

### Configurazione Docker e Bind Mount

Nel contesto Docker, la directory log è configurata con:

- **Volume Docker**: La directory `/logs/` interna al container è mappata al filesystem host
- **Bind mount**: Gli utenti autorizzati possono accedere direttamente ai file di log dal server host
- **Persistenza**: I log sopravvivono al riavvio dei container

Questo permette agli amministratori di sistema di:
- Accedere ai log in tempo reale
- Eseguire analisi offline
- Implementare politiche di backup personalizzate

## Gestione Automatica dei Log

### Sistema di Rotazione e Pulizia

ThothSL implementa un sistema automatico di gestione dei log su disco che opera secondo una logica di rotazione intelligente:

#### Logica di Rotazione

Il sistema gestisce i log attraverso:

1. **Raggruppamento periodico**: I log vengono raggruppati in base a:
   - Intervalli temporali (giornalieri/settimanali)
   - Dimensione dei file
   - Livello di dettaglio

2. **Criteri di eliminazione**:
   - **Log molto vecchi**: Eliminati automaticamente dopo un periodo configurabile (30 giorni di default)
   - **Politica di conservazione**: Mantenimento di un numero minimo di file storici
   - **Archiviazione**: I log importanti vengono spostati in `/logs/archives/`

#### Processo di Gestione

Il processo di gestione log opera come segue:

1. **Monitoraggio continuo**: Controllo periodico della dimensione e dell'età dei file
2. **Compressione**: I log vecchi vengono compressi per risparmiare spazio
3. **Archiviazione**: Log selezionati vengono spostati nella directory archives
4. **Pulizia**: Rimozione sicura dei log superati secondo le politiche di retention

### Configurazione del Logging

#### Livelli di Log

Il sistema supporta i seguenti livelli di log:
- **DEBUG**: Informazioni dettagliate per sviluppatori
- **INFO**: Messaggi informativi sulle operazioni normali
- **WARNING**: Avvisi su condizioni potenzialmente problematiche
- **ERROR**: Errori che non impediscono il funzionamento
- **CRITICAL**: Errori gravi che richiedono attenzione immediata

#### Formato dei Log

Ogni voce di log include:
```
[Timestamp] [Nome Logger] [Livello] - Messaggio
```

## Accesso ai Log

### Per Utenti Autorizzati

Gli utenti con accesso al server possono:

1. **Accesso diretto ai file**:
   ```bash
   tail -f /percorso/thothsl/logs/thoth_app.log
   ```

2. **Analisi tramite Docker**:
   ```bash
   docker logs -f thoth-ai
   ```

3. **Visualizzazione in Logfire**: Accesso web all'interfaccia di monitoraggio

### Integrazione con Strumenti di Monitoraggio

Il sistema di logging è progettato per integrarsi con:
- **Logfire Dashboard**: Per monitoraggio cloud
- **ELK Stack**: Per analisi avanzata
- **Grafana**: Per dashboard personalizzate
- **Script personalizzati**: Per automazione specifica

## Best Practices per la Gestione dei Log

### Per Amministratori

1. **Monitoraggio regolare**: Verificare periodicamente la crescita dei file di log
2. **Backup strategici**: Implementare backup dei log critici
3. **Politiche di retention**: Configurare periodi di conservazione appropriati
4. **Monitoraggio spazio**: Assicurarsi che ci sia sempre spazio sufficiente

### Per Sviluppatori

1. **Livelli appropriati**: Utilizzare il livello di log corretto per ogni situazione
2. **Messaggi descrittivi**: Fornire contesto sufficiente nei messaggi di log
3. **Struttura coerente**: Mantenere un formato uniforme per facilitare l'analisi

## Risoluzione Problemi

### Problemi Comuni

1. **Spazio disco insufficiente**: Il sistema automatico gestisce la pulizia
2. **Log non visibili**: Verificare i permessi di accesso alla directory logs
3. **Logfire non riceve dati**: Controllare la configurazione del token

### Comandi Utili

```bash
# Verificare spazio utilizzato
du -sh /percorso/thothsl/logs/

# Controllare log in tempo reale
tail -f /percorso/thothsl/logs/thoth_app.log

# Analizzare log per errori
grep -i error /percorso/thothsl/logs/thoth_app.log
```

Il sistema di logging di ThothSL fornisce una soluzione robusta e flessibile per il monitoraggio dell'applicazione, garantendo che sia gli sviluppatori che gli amministratori abbiano accesso completo alle informazioni necessarie per mantenere il sistema operativo ed efficiente.
