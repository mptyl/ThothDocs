# Installazione su Docker manuale

!!! note "Installazione di Docker"

    L'installazione e la configurazione di Docker sono attività al di fuori dell'ambito di questo documento.
    Eventualmente, seguire le istruzioni per [installare Docker sul vostro sistema](https://docs.docker.com/engine/install/).

Dando per scontato che Docker sia installato e funzionante, queste sono le azioni da eseguire per installare ThothAI sotto Docker senza usare l'installer.

## 1 - Impostare i database che si intende utilizzare nel file pyproject.toml
Per prima cosa è necessario impostare, nel file pyproject.toml, quali database si intende utilizzare. ThothAI usa un'approccio a plugin per la gestione dei database, avviando solo le librerie realmente necessarie per il supporto ai vari tipi di database.

Di default sono supportati sqlite e postgresql, ma possono essere aggiunti mysql, mariadb, sqlserver e oracle. Per poterlo fare è necessario trovare all'interno del file pyproject.toml la linee dedicata alla configurazione del dbmanager.

```
"thoth-dbmanager[postgresql,sqlite]==0.5.8",
```

Di default è impostata per gestire postgres ed sqlite, ma è possibile agggiungere, separati da virgole, mysql, mariadb, sqlserver ed oracle. Ad esempio:

```
"thoth-dbmanager[postgresql,sqlite,mariadb,sqlserver]==0.5.8",
```

## 2 - installare uv
Se non già presente nel sistema, si deve installare uv.

### Cos'è uv (package manager Python)

- __Descrizione__: `uv` è un package manager e una toolchain Python estremamente veloce (sviluppato da Astral, autori di Ruff). Può sostituire/integrare `pip` e `virtualenv`, offrendo performance elevate e ambienti riproducibili.
- __Caratteristiche principali__:
  - Risoluzione/installa dipendenze molto rapida (implementato in Rust).
  - Gestione ambienti virtuali integrata.
  - Supporto a `pyproject.toml`, `requirements.txt` e file di lock per riproducibilità.
  - Comandi unificati per installare pacchetti ed eseguire script/CLI (`uv run`).

### Installazione di uv

- __Guida ufficiale__: https://docs.astral.sh/uv/getting-started/installation/

In quella pagina trovi le istruzioni aggiornate per macOS, Linux e Windows.

> Nota: se si utilizza l'installer di ThothAI, l'installazione di `uv` viene eseguita automaticamente. In questa procedura manuale, invece, installalo seguendo la guida ufficiale.


## 3 - Impostazione del file _env
A questo punto è necessario creare e successivamente completare il file _env. Per farlo si deve:  

1. copiare il file `_env.template` in `_env`;
2. aprire con un editor qualunque il file `_env` e riempire i placeholder delle API key degli LLM che intendete utilizzare;
3. inserire le chiavi `SECRET_KEY` e `DJANGO_API_KEY` appena generate negli appositi placeholder.

    
## 4 - Inizializzazione dell'ambiente Docker e creazione del volume condiviso

!!! warning "Passaggio Fondamentale"
    Prima di eseguire `docker-compose up` è **obbligatorio** eseguire lo script di setup per inizializzare correttamente l'ambiente Docker e popolare il volume condiviso con i database di sviluppo.

### Eseguire lo script di setup
```bash
./setup-docker.sh
```

Questo script esegue operazioni critiche:
- Crea il network Docker `thothnet` (condiviso tra tutti i servizi ThothAI)
- Crea il volume Docker `thoth-shared-data` 
- **Copia i database di sviluppo** dalla directory `./data/dev_databases` nel volume condiviso
- Crea le directory necessarie (`logs`, `exports`, `setup_csv`, `qdrant_storage`)
- Verifica l'esistenza del file `_env`

!!! note "Volume Condiviso"
    Il volume `thoth-shared-data` è essenziale perché viene utilizzato sia da `thoth_be` che da `thoth_ui` per condividere i database e i file preprocessati (LSH, minhashes, etc.). Senza questo passaggio, l'applicazione si avvia ma non ha accesso ai database.

## 5 - Esecuzione del docker-compose up
Solo dopo aver eseguito con successo `setup-docker.sh`, è possibile procedere al deploy su Docker:

```bash
docker-compose up --build -d
```

### Verifica dell'installazione
Una volta eseguito il docker-compose up, verificare che:

1. I processi siano correttamente funzionanti:
```bash
docker-compose ps
```

2. Il volume condiviso contenga i database:
```bash
docker run --rm -v thoth-shared-data:/data alpine ls -la /data/
```
Dovreste vedere la directory `dev_databases` e i file database.

3. I log non mostrino errori:
```bash
docker-compose logs thoth-be
```

### Accesso all'applicazione
L'applicazione sarà disponibile su:
- Admin Backend: http://localhost:8040/admin
- UI (se installata): http://localhost:3001

## Troubleshooting

### Se il volume non contiene i database
Se avete eseguito `docker-compose up` senza prima eseguire `setup-docker.sh`:

```bash
# Fermare i container
docker-compose down

# Rimuovere il volume vuoto
docker volume rm thoth-shared-data

# Eseguire lo script di setup
./setup-docker.sh

# Riavviare i container
docker-compose up --build -d
```
